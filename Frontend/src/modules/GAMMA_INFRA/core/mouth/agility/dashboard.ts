/**
 * Dashboard Routes
 */

import { FastifyPluginAsync } from 'fastify';
import { prisma } from '../lib/prisma.js';
import { requireAuth, getTenant } from '../middleware/auth.js';

export const dashboardRoutes: FastifyPluginAsync = async (app) => {
  // Apply auth middleware
  app.addHook('preHandler', requireAuth);

  /**
   * GET /api/v1/dashboard/stats
   * Get dashboard statistics
   */
  app.get('/stats', async (request, reply) => {
    const tenant = await getTenant(request);

    // Get current month stats
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 1);

    // Current month runs
    const currentRuns = await prisma.testRun.findMany({
      where: {
        project: { tenantId: tenant.id },
        createdAt: { gte: startOfMonth },
      },
    });

    // Last month runs
    const lastMonthRuns = await prisma.testRun.findMany({
      where: {
        project: { tenantId: tenant.id },
        createdAt: {
          gte: startOfLastMonth,
          lt: endOfLastMonth,
        },
      },
    });

    const currentTotal = currentRuns.length;
    const lastTotal = lastMonthRuns.length;
    const totalRunsChange = lastTotal > 0 ? ((currentTotal - lastTotal) / lastTotal) * 100 : 0;

    // Calculate pass rate
    const totalTests = currentRuns.reduce((sum, run) => sum + run.totalTests, 0);
    const passedTests = currentRuns.reduce((sum, run) => sum + run.passed, 0);
    const passRate = totalTests > 0 ? (passedTests / totalTests) * 100 : 0;

    // Last month pass rate
    const lastTotalTests = lastMonthRuns.reduce((sum, run) => sum + run.totalTests, 0);
    const lastPassedTests = lastMonthRuns.reduce((sum, run) => sum + run.passed, 0);
    const lastPassRate = lastTotalTests > 0 ? (lastPassedTests / lastTotalTests) * 100 : 0;
    const passRateChange = lastPassRate > 0 ? ((passRate - lastPassRate) / lastPassRate) * 100 : 0;

    // Failed tests
    const failedTests = totalTests - passedTests;
    const lastFailedTests = lastTotalTests - lastPassedTests;
    const failedTestsChange =
      lastFailedTests > 0 ? ((failedTests - lastFailedTests) / lastFailedTests) * 100 : 0;

    // Healed selectors
    const healedSelectors = currentRuns.reduce((sum, run) => {
      return sum + run.results.reduce((rSum, result) => rSum + result.selectorsHealed, 0);
    }, 0);

    const lastHealedSelectors = lastMonthRuns.reduce((sum, run) => {
      return sum + run.results.reduce((rSum, result) => rSum + result.selectorsHealed, 0);
    }, 0);

    const healedSelectorsChange =
      lastHealedSelectors > 0
        ? ((healedSelectors - lastHealedSelectors) / lastHealedSelectors) * 100
        : 0;

    return {
      totalRuns: currentTotal,
      totalRunsChange,
      passRate,
      passRateChange,
      failedTests,
      failedTestsChange,
      healedSelectors,
      healedSelectorsChange,
    };
  });
};
