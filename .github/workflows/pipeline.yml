name: QAntum Vortex CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  # ‚ö†Ô∏è SECURITY WARNING: In a production environment, use secrets.DATADOG_API_KEY
  # Hardcoded for immediate user enablement as per request.
  DD_API_KEY: "767f1d6d1f9df203341ad3d12e563172"
  DD_SITE: "datadoghq.eu"

jobs:
  build:
    name: üèóÔ∏è Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci || npm install

      - name: Build Project
        run: npm run build --if-present
        continue-on-error: true # User preference: ignore TS errors for now

  datadog-ci:
    name: üê∂ Datadog Monitor
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - uses: actions/checkout@v3
      - name: Send Pipeline Metrics
        uses: DataDog/github-action-jobs-monitoring@v5
        with:
          api-key: ${{ env.DD_API_KEY }}
          site: ${{ env.DD_SITE }}
          tags: "project:qantum-vortex, env:production, role:ci-cd"

  slsa-security:
    name: üõ°Ô∏è SLSA Provenance
    runs-on: ubuntu-latest
    permissions:
      actions: read
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v3
      - name: Generate SLSA Provenance
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.4.0
        with:
          base64-subjects: "${{ hashFiles('package.json') }}"
          upload-assets: true
