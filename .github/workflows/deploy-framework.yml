name: Framework Singularity Deploy

on:
    push:
        branches: ["main"]
    workflow_dispatch:

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: us-central1
    BACKEND_SERVICE: framework-backend
    FRONTEND_SERVICE: framework-frontend

jobs:
    deploy-backend:
        runs-on: ubuntu-latest
        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Google Auth
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: "${{ secrets.GCP_SA_KEY }}"

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Authorize Docker push
              run: gcloud auth configure-docker

            - name: Build and Push Backend
              working-directory: ./Backend
              run: |
                  docker build -t gcr.io/$PROJECT_ID/$BACKEND_SERVICE:${{ github.sha }} .
                  docker push gcr.io/$PROJECT_ID/$BACKEND_SERVICE:${{ github.sha }}

            - name: Deploy Backend
              uses: google-github-actions/deploy-cloudrun@v2
              with:
                  service: ${{ env.BACKEND_SERVICE }}
                  image: gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
                  region: ${{ env.REGION }}
                  flags: "--allow-unauthenticated --port=8080"

    deploy-frontend:
        runs-on: ubuntu-latest
        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Google Auth
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: "${{ secrets.GCP_SA_KEY }}"

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Authorize Docker push
              run: gcloud auth configure-docker

            - name: Build and Push Frontend
              working-directory: ./Frontend
              run: |
                  docker build -t gcr.io/$PROJECT_ID/$FRONTEND_SERVICE:${{ github.sha }} .
                  docker push gcr.io/$PROJECT_ID/$FRONTEND_SERVICE:${{ github.sha }}

            - name: Deploy Frontend
              uses: google-github-actions/deploy-cloudrun@v2
              with:
                  service: ${{ env.FRONTEND_SERVICE }}
                  image: gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
                  region: ${{ env.REGION }}
                  flags: "--allow-unauthenticated --port=8080"
