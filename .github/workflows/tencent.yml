# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# QANTUM Framework - Tencent Kubernetes Engine Deployment
# Mega Hybrid Autonomous Cognitive Sovereign Meta-Logical Framework
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# This workflow builds the root Dockerfile with multi-stage builds for all components,
# publishes to Tencent Container Registry, and deploys to TKE cluster.
#
# Configuration:
# 1. Repository contains k8s/ directory with Kubernetes manifests
# 2. Required secrets:
#    - TENCENT_CLOUD_SECRET_ID
#    - TENCENT_CLOUD_SECRET_KEY
#    - TENCENT_CLOUD_ACCOUNT_ID
#    - TKE_REGISTRY_PASSWORD
# 3. Update environment variables below as needed
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: Tencent Kubernetes Engine - QANTUM Framework

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Environment variables available to all jobs and steps in this workflow
env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: qantum-framework-v1

permissions:
  contents: read

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    
    steps:
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 1. Checkout Repository
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ฅ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 2. Set up Build Environment
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ง Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: |
          image=moby/buildkit:latest
          network=host

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 3. Build Multi-Component Docker Image
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐๏ธ Build Docker Image (Multi-Stage)
      run: |
        echo "Building QANTUM Framework mega hybrid image..."
        echo "Image: ${TKE_IMAGE_URL}:${GITHUB_SHA}"
        echo "Also tagging as: ${TKE_IMAGE_URL}:latest"
        
        docker buildx build \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=${GITHUB_SHA} \
          --build-arg VERSION=${GITHUB_REF##*/} \
          --tag ${TKE_IMAGE_URL}:${GITHUB_SHA} \
          --tag ${TKE_IMAGE_URL}:latest \
          --file Dockerfile \
          --platform linux/amd64 \
          --load \
          .
        
        echo "โ Build completed successfully"
        docker images | grep mywebapp

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 4. Login to Tencent Container Registry
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Login to TKE Registry
      run: |
        echo "Logging into Tencent Container Registry..."
        docker login -u ${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }} -p '${{ secrets.TKE_REGISTRY_PASSWORD }}' ${TKE_IMAGE_URL}
        echo "โ Login successful"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 5. Push Images to Registry
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ค Push Docker Images
      run: |
        echo "Pushing images to registry..."
        docker push ${TKE_IMAGE_URL}:${GITHUB_SHA}
        docker push ${TKE_IMAGE_URL}:latest
        echo "โ Images pushed successfully"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 6. Set up Kustomize
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: โ๏ธ Set up Kustomize
      run: |
        echo "Installing Kustomize..."
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        chmod +x ./kustomize
        ./kustomize version
        echo "โ Kustomize installed"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 7. Configure kubectl for TKE
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Connect to TKE Cluster
      uses: TencentCloud/tke-cluster-credential-action@v1
      with:
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        tke_region: ${{ env.TKE_REGION }}
        cluster_id: ${{ env.TKE_CLUSTER_ID }}

    - name: ๐ฏ Switch to TKE Context
      run: |
        kubectl config use-context ${TKE_CLUSTER_ID}-context-default
        kubectl cluster-info
        echo "โ Connected to TKE cluster"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 8. Deploy to Kubernetes
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Deploy to Kubernetes
      run: |
        echo "Deploying QANTUM Framework to Kubernetes..."
        cd k8s
        
        # Update image tag in kustomization
        ../kustomize edit set image ${TKE_IMAGE_URL}:${GITHUB_SHA}
        
        # Preview changes
        echo "Preview of resources to be deployed:"
        ../kustomize build .
        
        # Apply to cluster
        ../kustomize build . | kubectl apply -f -
        
        echo "โ Deployment initiated"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 9. Wait for Rollout and Health Checks
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: โณ Wait for Deployment Rollout
      run: |
        echo "Waiting for deployment to complete..."
        kubectl rollout status deployment/${DEPLOYMENT_NAME} --timeout=10m
        echo "โ Deployment rolled out successfully"

    - name: ๐ฅ Verify Services
      run: |
        echo "Checking service status..."
        kubectl get services -o wide
        kubectl get pods -o wide
        kubectl get ingress
        echo "โ Services verified"

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # 10. Post-Deployment Health Check
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ฉบ Health Check
      run: |
        echo "Running health checks..."
        
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app=qantum-framework --timeout=300s
        
        # Check pod logs for errors
        echo "Recent pod logs:"
        kubectl logs -l app=qantum-framework --tail=50
        
        echo "โ Health checks passed"
        echo "๐ QANTUM Framework deployed successfully!"
        echo "Together with logic, we are invincible."
